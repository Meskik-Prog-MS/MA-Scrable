<?xml version="1.0" encoding="UTF-8"?>

<project>

    <target name="my-pre-clean">
        <exec dir="." executable="../scripts/rm-non-git.sh" output="/dev/null" 
	          failonerror="true" >
          <arg value="--except" />
          <arg value="./local.properties" />
        </exec>

        <exec dir="." executable="../scripts/ndksetup.sh" output="/dev/null" 
	          failonerror="true" >
            <arg value="${build.target}"/>
        </exec>
    </target>

    <target name="my-pre-build">

        <exec dir="." executable="../scripts/key-setup.sh" failonerror="true"
              >
          <arg value="${build.target}"/>
        </exec>

        <exec dir="." executable="../scripts/ndksetup.sh" output="/dev/null"
              failonerror="true">
            <arg value="${build.target}"/>
        </exec>

        <property name="CHAT_ENABLED" value="true" />
        <property name="THUMBNAIL_ENABLED" value="true" />
        <exec dir="." executable="../scripts/ndkbuild.sh" failonerror="true">
            <arg value="BUILD_TARGET=${build.target}" />
            <arg value="-j3"/>
            <arg value="INITIAL_CLIENT_VERS=${INITIAL_CLIENT_VERS}" />
            <arg value="CHAT_ENABLED=${CHAT_ENABLED}" />
            <arg value="THUMBNAIL_ENABLED=${THUMBNAIL_ENABLED}" />
            <arg value="VARIANT=${VARIANT_NAME}" />
            <arg value="V=1" />
        </exec>

        <exec dir="." executable="../scripts/mkimages.sh" 
              failonerror="true" output="/dev/null" 
              />

        <exec dir="." executable="../scripts/copy-strings.py" 
              failonerror="true" output="/dev/null"
              >
            <arg value="-k"/>
            <arg value="${SKIP_LANGS}"/>
        </exec>

        <exec dir="." executable="../scripts/mk_xml.py" 
              failonerror="true" 
              >
            <arg value="-o"/>
            <arg value="src/org/eehouse/android/${VARIANT_NAME}/loc/LocIDsData.java"/>
            <arg value="-t"/>
            <arg value="${build.target}"/>
            <arg value="-v"/>
            <arg value="${VARIANT_NAME}"/>
        </exec>

        <exec dir="." executable="../scripts/genvers.sh" output="/dev/null" 
              failonerror="true">
          <arg value="--variant" />
          <arg value="${VARIANT_NAME}" />
          <arg value="--client-vers" />
          <arg value="${INITIAL_CLIENT_VERS}" />
          <arg value="--chat-enabled"/>
          <arg value="${CHAT_ENABLED}" />
          <arg value="--thumbnail-enabled"/>
          <arg value="${THUMBNAIL_ENABLED}" />
          <arg value="--vers-outfile" />
          <arg value="./assets/gitvers.txt" />
        </exec>
    </target>

    <target name="my-copy-src">
        <exec dir="." executable="../scripts/mkvariant.sh" failonerror="true"
              output="/dev/null">
            <arg value="--variant-name"/>
            <arg value="${VARIANT_NAME}"/>
            <arg value="--app-name"/>
            <arg value="${APP_NAME}"/>
            <arg value="--dest-dir"/>
            <arg value="./res"/>
            <arg value="--dest-dir"/>
            <arg value="./src"/>
            <arg value="--dest-dir"/>
            <arg value="./jni"/>
            <arg value="--dest-dir"/>
            <arg value="./assets"/>
            <arg value="--dest-dir"/>
            <arg value="./libs"/>
            <arg value="--dest-dir"/>
            <arg value="./img_src"/>
            <arg value="--dest-dir"/>
            <arg value="./res_src"/>
        </exec>
    </target>

    <target name="my-pre-compile">
        <copy file="./gen/org/eehouse/android/${VARIANT_NAME}/R.java" todir="archive"/>

        <exec dir="." executable="../scripts/fake_locales.py" failonerror="true">
            <arg value="-l" />
            <arg value="ba_CK" />
            <arg value="-o" />
            <arg value="res_src/values-ba_CK/strings.xml" />
        </exec>
        <exec dir="." executable="../scripts/fake_locales.py" failonerror="true">
            <arg value="-l" />
            <arg value="ca_PS" />
            <arg value="-o" />
            <arg value="res_src/values-ca_PS/strings.xml" />
        </exec>
    </target>

    <target name="-post-build" >
      <if condition="${build.is.packaging.debug}">
        <then>
          <exec executable="git" outputproperty="git-rev" >
            <arg value="describe" />
          </exec>  
          <copy file="bin/XWords4-debug.apk" tofile="XWords4-debug-${git-rev}.apk"/>
          <echo>Created XWords4-debug-${git-rev}.apk</echo>
        </then>
      </if>
    </target>

</project>
